name: Improve proposal (slash command)

on:
  issue_comment:
    types: [created]

jobs:
  improve-proposal:
    name: Run proposal improvement
    runs-on: ubuntu-latest
    # Only run when the comment starts with the slash command
    if: startsWith(github.event.comment.body, '/improve-proposal')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse slash command
        id: parse
        uses: actions/github-script@v6
        with:
          script: |
            const body = context.payload.comment.body.trim();
            // syntax: /improve-proposal instr:<path> file:<path>
            // Supports quoted paths: instr:"path with spaces" file:'another path'
            function extract(key) {
              let m = body.match(new RegExp(key + '\\\\s*:\\\\s*(["'])(.*?)\\1','i'));
              if (m) return m[2].trim();
              m = body.match(new RegExp(key + '\\\\s*:\\\\s*(\\S+)','i'));
              return m ? m[1].trim() : '';
            }
            const instr = extract('instr');
            const file = extract('file');
            core.setOutput('instr', instr);
            core.setOutput('file', file);

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f scripts/requirements.txt ]; then pip install -r scripts/requirements.txt; fi

      - name: Run improvement script
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          INSTR="${{ steps.parse.outputs.instr }}"
          FILE="${{ steps.parse.outputs.file }}"
          if [ -z "$FILE" ] || [ -z "$INSTR" ]; then
            echo "No file or instructions path provided. Use: /improve-proposal instr:\"path to instructions\" file:\"path to target file\"" >&2
            exit 1
          fi
          echo "Improving proposal: $FILE using instructions: $INSTR"
          python scripts/improve_proposal.py --instructions "$INSTR" --file "$FILE"

      - name: Create Pull Request with results
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(proposal): improve ${{ steps.parse.outputs.file }}"
          branch: "improve-proposal-${{ github.run_id }}"
          title: "Improve proposal â€” ${{ steps.parse.outputs.file }}"
          body: |
            Automated proposal improvement using `.github/instructions/metodologia-melhoria-proposta.instructions.md`.

            Command: `${{ github.event.comment.body }}`
